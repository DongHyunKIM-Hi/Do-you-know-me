<!DOCTYPE HTML>
<!--
	Intensify by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>
	<head>
		<title>Intensify by TEMPLATED</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<audio id='audio_play' src='/static/image/test.mp3'></audio> 
		<script type="text/javascript"> 
		function play() { 
			var audio = document.getElementById('audio_play'); 
			if (audio.paused) { 
				audio.play(); 
			}else{ 
				audio.pause(); 
				audio.currentTime = 0 
			} 
		} 
		</script>
		
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css">
		<link rel="stylesheet" href="/static/css/main.css" />
		
		
		
		<style>
		.graph {
			position: relative; /* IE is dumb */
			width: 200px;
			border: 1px solid  #f6755e;
			padding: 2px;
			font-size: 11px;
			font-family: tahoma;
			margin-bottom: 3px;
			}
			.graph .bar {
			display: block;
			position: relative;
			background:#f6755e;
			text-align: center;
			color: #333;
			height: 2em;
			line-height: 2em;
			}
			.graph .bar span {
			position: absolute;
			left: 1em;
}

		.section {
			padding: 1rem 1.5rem;
			max-width: 750px;
			margin: auto;
		}
		.image img {
			object-fit:cover;
			width:100%;
			height:100%;
		}

		#three{
			width:1200px;
			margin:auto;
			
		}

		#best{
			width:1200px;
			margin:auto;
		}

		#best-post-box{
			height: 400px;
		}

		
		#chartdiv {
  width: 100%;
  height: 500px;
}
		</style>
		
	</head>
	<body>
		

		<!-- Header --> 
		<header id="header">
			<nav class="left">
				<a onclick='$("#modal-my-post").addClass("is-active");' class="image is-48x48" style="margin-top: 23px;">
					<img class="is-rounded" src="static/image/profile_placeholder.png">
				</a>
			</nav>
			<a onclick="home_return()" class="logo">why!why!!</a>
			<nav class="right">
				<button onclick="logout()">Log out</button>	
			</nav>
		</header>

		<div class="modal" id="modal-my-post">
			<div class="modal-background" onclick='$("#modal-my-post").removeClass("is-active")'></div>
			<div class="modal-content" style="width: 1500px;">
				<div class="box">
					<article class="media">
						<div class="media-content">
							<div class="field">
								<h3>내가 작성한 분노</h3>			
								<div class="container">
									<div class="header_wrap">
									<div class="num_rows">
							
										
									</div>										
								</div>
								<table class="table table-striped table-class" id="table-id" style="width:700px; margin: auto;">
							
							
									<thead>
										<tr>
											<th>키워드</th>
											<th>내용</th>
											<th>Like!</th>
										</tr>
									</thead>
									<tbody id="post-my-story">

									</tbody>
								</table>

									<div class="level-item" style="margin-top: 50px;">
										<a class="button is-sparta is-outlined"
										   onclick='$("#modal-my-post").removeClass("is-active")'>닫기</a>
									</div>
								</div>
							</nav>
						</div>
					</article>
				</div>
			</div>
			<button class="modal-close is-large" aria-label="close"
					onclick='$("#modal-post").removeClass("is-active")'></button>
		</div>

		<!-- Menu -->
			<!-- <nav id="menu">
				<ul class="links">
					<li><a href="index.html">Home</a></li>
					<li><a href="generic.html">Generic</a></li>
					<li><a href="elements.html">Elements</a></li>
				</ul>
				<ul class="actions vertical">
					<li><a href="#" class="button fit">Login</a></li>
				</ul>
			</nav> -->
			
			
			
		<!-- Banner -->
			<section id="banner" style="padding-top: 20px; padding-bottom: 0px;">
				<div class="content">
					<iframe width="890" height="501" src="https://www.youtube.com/embed/pEwJpMBi9sg?amp;autoplay=1&mute=1&start=123" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
				</div>
			</section>
			<div id="chartdiv"></div>
		<!-- One -->
			<section id="one" class="wrapper">
				<div class="inner flex flex-3">
					<div class="flex-item left">
						<div>
							<h3>화나는 것을 표현해보세요.</h3>
							<p><br /></p>
						</div>
						<div>
							<h3>감정 쓰레기통</h3>
							<p><br /></p>
						</div>
					</div>
					<div class="flex-item image fit round">
						<img src="static/image/123.gif" alt="" />
					</div>
					<div class="flex-item right">
						<div>
							<h3>공감버튼을 눌러주세요</h3>
							<p><br /></p>
						</div>
						<div>
							<h3>항해99동안 쌓인 스트레스</h3>
							<p><br /></p>
						</div>
					</div>
				</div>
			</section>
			
			
			
			<section class="section">
				<article class="media">
					<figure class="media-left" style="align-self: center">
						<a class="image is-32x32">
							<img class="is-rounded" src="static/image/profile_placeholder.png">
						</a>
					</figure>
					<div class="media-content">
						<div class="field">
							<p class="control">
								<input id="input-post" class="input is-rounded" placeholder="무슨 생각을 하고 계신가요?"
									   onclick='$("#modal-post").addClass("is-active")'></p>
						</div>
					</div>
				</article>
				<div class="modal" id="modal-post">
					<div class="modal-background" onclick='$("#modal-post").removeClass("is-active")'></div>
					<div class="modal-content">
						<div class="box">
							<article class="media">
								<div class="media-content">
									<div class="field">
										<h3>분노를 표출해주세요!!</h3>
										<p class="control" >
											<div  class="row justify-content-center align-items-center h-100" >
												<div  class="row justify-content-center align-items-center h-100" >
													<div  class="form-group" style="width: 500px;">
														<select id="keyword" class="mul-select" multiple="true" style="width: 500px;">
															<option value="Git">Git</option>
															<option value="Aws">Aws</option>
															<option value="Python">Python</option>
															<option value="미니프로젝트">미니프로젝트</option>
															<option value="구글링">구글링</option>
															<option value="vscode">vscode</option>
															<option value="mongoDB">mongoDB</option>
														</select>
													</div> 
											   </div>
											</div>
										</p>
										<p class="control">
													<textarea id="textarea-post" class="textarea"
															  placeholder="무슨 생각을 하고 계신가요?"></textarea>
										</p>
									</div>
									<nav class="level is-mobile">
										<div class="level-left">
			
										</div>
										<div class="level-right">
											<div class="level-item">
												<a class="button is-sparta" onclick="post()"  onmouseover="play()">포스팅하기</a>
											</div>
											<div class="level-item">
												<a class="button is-sparta is-outlined"
												   onclick='$("#modal-post").removeClass("is-active")'>취소</a>
											</div>
										</div>
									</nav>
								</div>
							</article>
						</div>
					</div>
					<button class="modal-close is-large" aria-label="close"
							onclick='$("#modal-post").removeClass("is-active")'></button>
				</div>
			</section>

		<!-- Three -->
			
			<section id="best" class="container">
				<h3> -BEST-</h3>
				<div id="best-post-box" class="card-columns">
					

				</div>
			</section>

			<section id="three" class="container">
				<h3> -최신순-</h3>
				<div id="post-box" class="card-columns">
					
	<div style="display: inline;">
				</div>
			</section>

		<!-- Footer -->
		<footer id="footer">
			<div class="inner">
				<h2>23조</h2>
				<ul class="actions">
					<li> <a href="#">김승욱</a></li>
					<li> <a href="#">김동현</a></li>
					<li> <a href="#">이명섭</a></li>
				</ul>
			</div>
			<div class="copyright">
				&copy; Untitled. Design <a href="https://templated.co">TEMPLATED</a>. Images <a
					href="https://unsplash.com">Unsplash</a>.
			</div>
		</footer>
			
		<!-- Scripts -->
			<!-- <script src="static/assets/js/jquery.min.js"></script> -->
			<script src="static/assets/js/jquery.scrolly.min.js"></script>
			<script src="static/assets/js/skel.min.js"></script>
			<script src="static/assets/js/util.js"></script>
			<script src="static/assets/js/main.js"></script>
			<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> -->
    		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
			<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
			<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
			<script src="https://cdn.amcharts.com/lib/4/plugins/wordCloud.js"></script>
			<script src="https://cdn.amcharts.com/lib/4/themes/dataviz.js"></script>
			<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
			<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

			<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-*.min.js"></script>
    		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    		<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>
    		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
			<script>
				function post() {
					let keyword = $("#keyword option:selected").text()
				let comment = $("#textarea-post").val()
				let today = new Date().toISOString()
				
				$.ajax({
					type: "POST",
					url: "/posting",
					data: {
						keyword_give : keyword,
						comment_give: comment,
						date_give : today
						
					},
					success: function (response) {
						$("#modal-post").removeClass("is-active")
						window.location.reload()
					}
				})
			}

			function toggle_like(post_id, type) {
				console.log(post_id, type)
				let $a_like = $(`#${post_id} a[aria-label='heart']`)
				let $i_like = $a_like.find("i")
				if ($i_like.hasClass("fa-heart")) {
					$.ajax({
					type: "POST",
					url: "/update_like",
					data: {
						post_id_give: post_id,
						type_give: type,
						action_give: "unlike"
					},
					success: function (response) {
						console.log("unlike")
						$i_like.addClass("fa-heart-o").removeClass("fa-heart")
						$a_like.find("span.like-num").text(num2str(response["count"]))
					}
					})
				} else {
					$.ajax({
					type: "POST",
					url: "/update_like",
					data: {
						post_id_give: post_id,
						type_give: type,
						action_give: "like"
					},
					success: function (response) {
						console.log("like")
						$i_like.addClass("fa-heart").removeClass("fa-heart-o")
						$a_like.find("span.like-num").text(response["count"])
					}
					})
				}
			}
			function sound(){
				eval(str)
			}
			function get_top_posts(){
				$.ajax({
					type: "GET",
					url: "/get_top_posts",
					data: {},
					success: function (response) {
						if (response["result"] == "success") {
							let posts = response["posts"]
							for (let i = 0; i < posts.length; i++) {
								let post = posts[i]
								let time_post = new Date(post["date"])

								let time_before = time2str(time_post)
                                 
								let class_heart = post['heart_by_me'] ? "fa-heart" : "fa-heart-o"
								let count_heart = post['count_heart']

								let html_temp = `<div id="${post["_id"]}" class="card">
													<div id='content' class="card-content">
														<p class="title">
															${post['keyword']}
														</p>
														<p class="subtitle">
														${post['comment']}
														</p>
														<div class="graph">
															<strong class="bar" style="width: ${post['angry']}%;">${post['angry']}</strong>
														</div>
													</div>
													<footer class="card-footer">
														<p class="card-footer-item">
														<span>
															
															<a class="level-item is-sparta" aria-label="heart" onclick="toggle_like('${post["_id"]}','heart')">
																<span class="icon is-small"><i style=color:red class="fa ${class_heart}" aria-hidden="true"></i></span>&nbsp;
																<span style=color:red class="like-num">${num2str(count_heart)}</span>
															</a>
														
														</span>
														</p>
														<p class="card-footer-item">
														<span>
															${post['nick']}
															
														</span>
														<p class="card-footer-item">
														<span>
														${time_before}
														</span>
														</p>
													</footer>
												 
													</div>`
								$("#best-post-box").append(html_temp)
							}
						}
					}
				})
			}
			function get_keyword(){
			$("#chartdiv").empty()
            $.ajax({
                type: "GET",
                url: "/get_textCloud",
                data: {},
                success: function (response) {
                    if (response["result"] == "success") {
                        let keyword_list = response['keyword_list']
						make_textCloud(keyword_list)
						
					}else{
						alert("불러오기 오류")
					}
                    }
                }
            )
			}
			function get_posts() {
            $("#post-box").empty()
            $.ajax({
                type: "GET",
                url: "/get_posts",
                data: {},
                success: function (response) {
                    if (response["result"] == "success") {
                        let posts = response["posts"]
                        for (let i = 0; i < posts.length; i++) {
                            let post = posts[i]
                            let time_post = new Date(post["date"])

                            let time_before = time2str(time_post)

                            let class_heart = post['heart_by_me'] ? "fa-heart" : "fa-heart-o"
              				let count_heart = post['count_heart']

                            let html_temp = `<div id="${post["_id"]}" class="card">
												<div id='content' class="card-content">
													<p class="title">
														${post['keyword']}
													</p>
													<p class="subtitle">
													${post['comment']}
													</p>
													<div class="graph">
															<strong class="bar" style="width: ${post['angry']}%;">${post['angry']}</strong>
														</div>
												</div>
												<footer class="card-footer">
													<p class="card-footer-item">
													<span>
														
														<a class="level-item is-sparta" aria-label="heart" onclick="toggle_like('${post["_id"]}','heart')">
															<span class="icon is-small"><i style=color:red class="fa ${class_heart}" aria-hidden="true"></i></span>&nbsp;
															<span style=color:red class="like-num">${num2str(count_heart)}</span>
														</a>
													
													</span>
													</p>
													<p class="card-footer-item">
													<span>
														${post['nick']}
														
													</span>
													<p class="card-footer-item">
													<span>
													${time_before}
													</span>
													</p>
												</footer>
												</div>`
                            $("#post-box").append(html_temp)
                        }
                    }
                }
            })
        }

		function get_my_story(){
				$.ajax({
					type: "GET",
					url: "/get_my_story",
					data: {},
					success: function (response) {
						if (response["result"] == "success") {
							let posts = response["posts"]
							for (let i = 0; i < posts.length; i++) {
								let post = posts[i]                                
								let time_post = new Date(post["date"])
								let time_before = time2str(time_post)
								let class_heart = post['heart_by_me'] ? "fa-heart" : "fa-heart-o"
								let count_heart = post['count_heart']
								let html_temp = `<tr id=${post["_id"]}>														
														<th>${post["keyword"]}</th>
														<th>${post["comment"]}</th>
														<th>
															${post["like"]}	
														</th>							
												</tr>`			
								$("#post-my-story").append(html_temp)
							}
						}
					}
				})
			}

		

		function time2str(date) {
            let today = new Date()
            let time = (today - date) / 1000 / 60  // 분

            if (time < 60) {
                return parseInt(time) + "분 전"
            }
            time = time / 60  // 시간
            if (time < 24) {
                return parseInt(time) + "시간 전"
            }
            time = time / 24
            if (time < 7) {
                return parseInt(time) + "일 전"
            }
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`
        }

		function make_textCloud(keyword_list) {
				// Themes begin
				
				am4core.useTheme(am4themes_dataviz);
				am4core.useTheme(am4themes_animated);
				// Themes end
				
				var chart = am4core.create("chartdiv", am4plugins_wordCloud.WordCloud);
				var series = chart.series.push(new am4plugins_wordCloud.WordCloudSeries());
				
				series.accuracy = 4;
				series.step = 15;
				series.rotationThreshold = 0.7;
				series.maxCount = 200;
				series.minWordLength = 2;
				series.labels.template.margin(4,4,4,4);
				series.maxFontSize = am4core.percent(30);
				
				series.text = keyword_list; 
				
				series.colors = new am4core.ColorSet();
				series.colors.passOptions = {}; // makes it loop
				
				//series.labelsContainer.rotation = 45;
				series.angles = [0,-90];
				series.fontWeight = "700"
				
				setInterval(function () {
				series.dataItems.getIndex(Math.round(Math.random() * (series.dataItems.length - 1))).setValue("value", Math.round(Math.random() * 10));
				}, 10000)
				
				}; // end 
		function num2str(count) {
			if (count > 10000) {
				return parseInt(count / 1000) + "k"
			}
			if (count > 500) {
				return parseInt(count / 100) / 10 + "k"
			}
			if (count == 0) {
				return ""
			}
			return count
			}
			$(document).ready(function () {
			get_posts()
			get_top_posts()
			get_keyword()
			get_my_story()
			$(".mul-select").select2({
                    placeholder: "select country", //placeholder
                    tags: true,
                    tokenSeparators: ['/',',',';'," "] 
            });
			})

		
		function logout(){
			alert("로그아웃 되었습니다")
			$.removeCookie('mytoken', { path: '/' }); 
			window.location.href = '/login'
		}

		function home_return(){
			window.location.href ='/'
		}
		
		
			</script>
	</body>
</html>